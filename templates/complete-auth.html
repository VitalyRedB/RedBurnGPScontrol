<!-- /templates/complete_auth.html -->
<!-- регистрация или новый пароль -->
{% extends "base_new.html" %}

{% block title %}
<title>Завершение регистрации</title>
{% endblock %}

{% block body %}
<div class="panel">
    <h2 id="title">Завершение</h2>

    <form id="completeForm">
        <div id="usernameBlock" style="display:none;">
            <label>Username</label><br>
            <input type="text" id="username"><br><br>
        </div>

        <label>Пароль</label><br>
        <input type="password" id="password"><br><br>

        <label>Повторите пароль</label><br>
        <input type="password" id="password2"><br><br>

        <button type="submit">Сохранить</button>
    </form>

    <div id="msg"></div>
</div>

<script>
const TOKEN = "{{ token }}";
const MODE  = "{{ mode }}"; // "register" | "reset"

if (MODE === "register") {
    document.getElementById("usernameBlock").style.display = "block";
    document.getElementById("title").innerText = "Завершение регистрации";
} else {
    document.getElementById("title").innerText = "Смена пароля";
}

document.getElementById("completeForm").addEventListener("submit", async e => {
    e.preventDefault();

    const password = password.value;
    const password2 = password2.value;
    const username = document.getElementById("username")?.value;

    if (password !== password2) {
        msg.innerText = "Пароли не совпадают";
        return;
    }

    const res = await fetch("/api/complete-auth", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ token: TOKEN, password, username })
    });

    const data = await res.json();
    msg.innerText = data.message;
});
</script>
{% endblock %}
