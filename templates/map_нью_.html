{% extends "base_new.html" %}

{% block title %}
<title>GPS точки (новая карта)</title>
{% endblock %}

{% block body %}

<!-- === КАРТА === -->
<div id="map" style="height:50vh; width:100%;"></div>

<!-- === СПИСОК ТОЧЕК ПОД КАРТОЙ === -->
<h4>Список точек пользователя1</h4>
    <div id="pointsList" style="max-height:25vh; overflow-y:auto; margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">
    </div>

<!-- === Leaflet === -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([50.45, 30.52], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
const markersLayer = L.layerGroup().addTo(map);

// === Иконки ===
const activeIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
});
const passiveIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
});

// === Получение текущего пользователя ===
async function getCurrentUserId() {
    try {
        const res = await fetch('/whoami');
        const data = await res.json();
        return data.user ? data.user.id : null;
    } catch (err) {
        console.error("Ошибка получения пользователя:", err);
        return null;
    }
}

// === Загрузка точек ===
async function loadPoints(userId) {
    if (!userId) return [];
    try {
        const res = await fetch(`/api/points_new?user_id=${userId}`);
        const points = await res.json();
        console.log("Points:", points);
        return points;
    } catch (err) {
        console.error("Ошибка загрузки точек:", err);
        return [];
    }
}

// === Отрисовка точек на карте ===
function updateMap(points) {
    markersLayer.clearLayers();
    if (!points || points.length===0) return;

    points.forEach(pt => {
        if(pt.lat==null || pt.lon==null) return;
        const icon = pt.is_active===1 ? activeIcon : passiveIcon;
        const marker = L.marker([pt.lat, pt.lon], {icon}).addTo(markersLayer);
        marker.bindPopup(`<b>${pt.tracker_name}</b><br>${pt.date} ${pt.time}<br>Status: ${pt.is_active===1 ? "Active":"Passive"}`);
    });

    map.fitBounds(markersLayer.getBounds(), {padding:[50,50]});
}

// === Отображение списка точек под картой ===
function showPointsList(points) {
    const container = document.getElementById("pointsList");
    container.innerHTML = '';
    if(!points || points.length===0) {
        container.innerHTML = '<div>Нет точек для отображения</div>';
        return;
    }

    points.forEach(pt => {
        const div = document.createElement("div");
        div.textContent = `test1-ID: ${pt.id}, Tracker: ${pt.tracker_name}, Lat: ${pt.lat}, Lon: ${pt.lon}, Date: ${pt.date}, Time: ${pt.time}, Active: ${pt.is_active}`;
        container.appendChild(div);
    });
}

// === Инициализация ===
(async () => {
    const userId = await getCurrentUserId();
    if (!userId) {
        alert("Пользователь не выбран!");
        return;
    }
    const points = await loadPoints(userId);
    updateMap(points);
    showPointsList(points);
})();
</script>



</script>
<h3>Список точек пользователя2</h3>
<div id="pointsList"></div>
<div id="pointsList" style="max-height:25vh; overflow-y:auto; margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">
    </div>

<script>
// --- Получаем текущего пользователя (id) ---
async function getCurrentUserId() {
    const res = await fetch('/whoami');
    const data = await res.json();
    return data.user ? data.user.id : null;
}

// --- Загрузка точек ---
async function loadPoints(userId) {
    if (!userId) return;
    const res = await fetch(`/api/points_new?user_id=${userId}`);
    const points = await res.json();
    console.log("Points:", points);
    return points;
}

// --- Отображение точек на экране 2 ---
function showPoints2(points) {
    const container = document.getElementById("pointsList");
    container.innerHTML = "";
    points.forEach(pt => {
        const div = document.createElement("div");
        div.textContent = `nest2_ID: ${pt.id}, Tracker: ${pt.tracker_name}, Lat: ${pt.lat}, Lon: ${pt.lon}, Date: ${pt.date}, Time: ${pt.time}, Active: ${pt.is_active}`;
        container.appendChild(div);
    });
}

// --- Инициализация 2 ---
(async () => {
    const userId = await getCurrentUserId();
    if (!userId) {
        alert("Пользователь не выбран!");
        return;
    }
    const points = await loadPoints(userId);
    showPoints2(points);
})();
</script>

{% endblock %}