{% extends "base_new.html" %}

{% block title %}
<title>GPS точки (новая карта1)</title>
{% endblock %}

{% block body %}

<div id="map" style="height:600px;"></div>

<!-- === Leaflet === -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([50.45, 30.52], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markersLayer = L.layerGroup().addTo(map);

// --- Получаем текущего пользователя (id) ---
async function getCurrentUserId() {
    const res = await fetch('/whoami');
    const data = await res.json();
    return data.user ? data.user.id : null;
}

// --- Загрузка трекеров пользователя ---
async function loadTrackers(userId) {
    const res = await fetch(`/api/trackers?user_id=${userId}`);
    const trackers = await res.json();
    console.log("Trackers:", trackers);
    return trackers.map(t => t.id); // возвращаем массив id трекеров
}

// --- Загрузка точек пользователя ---
async function loadPoints(userId, trackerIds=[]) {
    const params = new URLSearchParams({user_id: userId});
    trackerIds.forEach(tid => params.append("tracker_id", tid));

    const res = await fetch('/api/points_new?' + params.toString());
    const points = await res.json();
    console.log("Points:", points);
    updateMap(points);
}

// --- Обновление карты ---
function updateMap(points) {
    markersLayer.clearLayers();
    points.forEach(pt => {
        const iconUrl = pt.is_active == 1 ?
            'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png' :
            'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
        const icon = L.icon({iconUrl, iconSize:[25,41], iconAnchor:[12,41]});
        const marker = L.marker([pt.lat, pt.lon], {icon}).addTo(markersLayer);
        marker.bindPopup(`<b>${pt.tracker_name}</b><br>${pt.date} ${pt.time}<br>Status: ${pt.is_active==1 ? "Active":"Passive"}`);
    });
    if(points.length>0) map.fitBounds(markersLayer.getBounds());
}

// --- Инициализация карты ---
(async () => {
    const userId = await getCurrentUserId();
    if (!userId) {
        alert("Пользователь не выбран!");
        return;
    }
    const trackerIds = await loadTrackers(userId);
    await loadPoints(userId, trackerIds);
})();
</script>

{% endblock %}





