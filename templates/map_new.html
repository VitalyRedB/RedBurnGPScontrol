{% extends "base_new.html" %}

{% block title %}
<title>GPS точки (новая карта)</title>
{% endblock %}

{% block body %}

<!-- === КАРТА === -->
<div id="map" style="height:50vh; width:100%;"></div>

<!-- === СПИСОК ТОЧЕК ПОД КАРТОЙ === -->
<h4>Список точек пользователя</h4>
<div id="pointsList"
     style="max-height:25vh; overflow-y:auto; margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">
</div>

<!-- === Leaflet === -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>


<!-- ========================================================= -->
<!-- ====================== MAP.JS =========================== -->
<!-- ========================================================= -->
<script>
// === Инициализация карты ===
const map = L.map('map').setView([50.45, 30.52], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

// === ОДИН слой для маркеров ===
const markersLayer = L.markerClusterGroup().addTo(map);

// === Иконки ===
const activeIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
});
const passiveIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
});

// === Тестовая точка Киева ===
function addTestPoint() {
    const m = L.marker([50.4501, 30.5234]).addTo(markersLayer);
    m.bindPopup("Тестовая точка: Киев");
}

// === Отрисовка точек на карте ===
function updateMap(points) {
    markersLayer.clearLayers();
    if (!points || points.length === 0) return;

    points.forEach(pt => {
        if (!pt.lat || !pt.lon) return;
        const icon = pt.is_active === 1 ? activeIcon : passiveIcon;

        const marker = L.marker([pt.lat, pt.lon], {icon});
        marker.bindPopup(
            `<b>${pt.tracker_name}</b><br>${pt.date} ${pt.time}<br>Status: ${pt.is_active ? "Active" : "Passive"}`
        );
        markersLayer.addLayer(marker);
    });

    if (markersLayer.getLayers().length > 0)
        map.fitBounds(markersLayer.getBounds(), {padding:[50,50]});
}

// === Список точек под картой ===
function showPoints(points) {
    const box = document.getElementById("pointsList");
    box.innerHTML = "";
    points.forEach(pt => {
        const div = document.createElement("div");
        div.textContent =
            `ID: ${pt.id}, Tracker: ${pt.tracker_name}, Lat: ${pt.lat}, Lon: ${pt.lon}, ` +
            `Date: ${pt.date}, Time: ${pt.time}, Active: ${pt.is_active}`;
        box.appendChild(div);
    });
}
</script>



<!-- ========================================================= -->
<!-- ====================== API.JS =========================== -->
<!-- ========================================================= -->
<script>
// Получение user_id
async function getCurrentUserId() {
    const res = await fetch('/whoami');
    const data = await res.json();
    return data.user ? data.user.id : null;
}

// Загрузка точек
async function loadUserPoints(userId) {
    if (!userId) return [];
    const res = await fetch(`/api/points_new?user_id=${userId}`);
    return await res.json();
}
</script>



<!-- ========================================================= -->
<!-- ==================== LOGIN.JS ========================== -->
<!-- ========================================================= -->
<script>
// Открыть/закрыть окно логина
function openLogin()  { document.getElementById("loginPanel").style.display = "block"; }
function closeLogin() { document.getElementById("loginPanel").style.display = "none"; }

// ЛОГИН
function login() {
    const username = document.getElementById("usernameInput").value;
    const password = document.getElementById("passwordInput").value;

    fetch("/api/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username, password})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "ok") {
            closeLogin();
            updateUIAfterLogin(data.user);
        } else {
            alert("Invalid username or password");
        }
    });
}

// РЕГИСТРАЦИЯ
function register() {
    const username = document.getElementById("regUsername").value;
    const password = document.getElementById("regPassword").value;

    fetch("/api/register", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,password})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "ok") {
            closeLogin();
            updateUIAfterLogin(data.user);
        } else {
            alert(data.message);
        }
    });
}

// ЛОГАУТ
function logout() {
    fetch("/logout").then(() => {
        document.getElementById("currentUser").textContent = "";
        const btn = document.getElementById("loginBtn");
        btn.textContent = "Log In";
        btn.onclick = openLogin;

        document.getElementById("selectTrackersBtn").disabled = true;

        markersLayer.clearLayers();
    });
}

// После логина
function updateUIAfterLogin(user) {
    document.getElementById("currentUser").textContent = "Logged in as: " + user.username;

    const btn = document.getElementById("loginBtn");
    btn.textContent = "Log Out";
    btn.onclick = logout;
    document.getElementById("selectTrackersBtn").disabled = false;

    // === Получаем точки и обновляем список + карту ===
    loadUserPoints(user.id).then(points => {
        console.log("Points loaded after login:", points);
        showPoints(points);      // ← ЭТОГО НЕ БЫЛО
        updateMap(points);
    });
}

</script>



<!-- ========================================================= -->
<!-- =============== ИНИЦИАЛИЗАЦИЯ СТРАНИЦЫ ================== -->
<!-- ========================================================= -->
<script>
// === ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ ===
(async () => {
    const info = await fetch("/whoami").then(r => r.json());

    if (!info.user) {
        addTestPoint();
        return;
    }

    updateUIAfterLogin(info.user);

    const points = await loadUserPoints(info.user.id);
    showPoints(points);
    updateMap(points);
})();
</script>



{% endblock %}












