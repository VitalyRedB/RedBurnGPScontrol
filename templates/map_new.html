{% extends "base_new.html" %}

{% block title %}
<title>GPS точки (новая карта)</title>
{% endblock %}

{% block body %}

<!-- === КАРТА === -->
<div id="map" style="height:50vh; width:100%;"></div>

<!-- === СПИСОК ТОЧЕК ПОД КАРТОЙ === -->
<h4>Список точек пользователя</h4>
<div id="pointsList"
     style="max-height:25vh; overflow-y:auto; margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">
</div>

<!-- === Leaflet === -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css') }}">
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>


<!-- ========================================================= -->
<!-- ====================== MAP.JS =========================== -->
<!-- ========================================================= -->
<script>
// === Инициализация карты ===
const map = L.map('map').setView([50.45, 30.52], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

// === ОДИН слой для маркеров ===
const markersLayer = L.markerClusterGroup().addTo(map);

// === Иконки ===
const activeIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
});
const passiveIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
});

// === Тестовая точка Киева ===
function addTestPoint() {
    const m = L.marker([50.4501, 30.5234]).addTo(markersLayer);
    m.bindPopup("Тестовая точка: Киев");
}

// === Отрисовка точек на карте ===
function updateMap(points) {
    markersLayer.clearLayers();
    if (!points || points.length === 0) return;

    points.forEach(pt => {
        if (!pt.lat || !pt.lon) return;
        const icon = pt.is_active === 1 ? activeIcon : passiveIcon;

        const marker = L.marker([pt.lat, pt.lon], {icon});
        marker.bindPopup(
            `<b>${pt.tracker_name}</b><br>${pt.date} ${pt.time}<br>Status: ${pt.is_active ? "Active" : "Passive"}`
        );
        markersLayer.addLayer(marker);
    });

    if (markersLayer.getLayers().length > 0)
        map.fitBounds(markersLayer.getBounds(), {padding:[50,50]});
}

// === Список точек под картой ===
function showPoints(points) {
    const box = document.getElementById("pointsList");
    box.innerHTML = "";
    points.forEach(pt => {
        const div = document.createElement("div");
        div.textContent =
            `ID: ${pt.id}, Tracker: ${pt.tracker_name}, Lat: ${pt.lat}, Lon: ${pt.lon}, ` +
            `Date: ${pt.date}, Time: ${pt.time}, Active: ${pt.is_active}`;
        box.appendChild(div);
    });
}
</script>

<!-- ========================================================= -->
<!-- ====================== API.JS =========================== -->
<!-- ========================================================= -->
<script>
let currentUser = null;
// Получение user_id
async function getCurrentUserId() {
    const res = await fetch('/whoami');
    const data = await res.json();
    return data.user ? data.user.id : null;
}

// Загрузка точек
async function loadUserPoints(userId) {
    if (!userId) return [];
    const res = await fetch(`/api/points_new?user_id=${userId}`);
    return await res.json();
}

async function refreshUserData(userId) {
    const listBox = document.getElementById("pointsList");

    if (!userId) {
        // нет пользователя → пустой список, карта = Киев
        listBox.innerHTML = "";
        markersLayer.clearLayers();
        map.setView([50.45, 30.52], 10);
        return;
    }

    const points = await loadUserPoints(userId);

    showPoints(points);
    updateMap(points);
}

</script>

<!-- ========================================================= -->
<!-- ==================== LOGIN.JS ========================== -->
<!-- ========================================================= -->
<script>
// === ПАНЕЛИ ===
function closeAllPanels() {
    document.getElementById("loginPanel").style.display = "none";
    document.getElementById("trekers-panel").style.display = "none";}

// === Открыть или Закрыть окно логина ===
function openLogin() {closeAllPanels(); document.getElementById("loginPanel").style.display = "block";}
function closeLogin() {document.getElementById("loginPanel").style.display = "none";}

// ЛОГИН
function login() {
    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value.trim();

    fetch("/api/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username, password }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "ok") {
            updateUIAfterLogin(data.user);
            closeLogin();      // закрываем окно логина

        } else {
            alert("Wrong login or password");
        }
    });
}

// РЕГИСТРАЦИЯ
function register() {
    const username = document.getElementById("regUsername").value;
    const password = document.getElementById("regPassword").value;

    fetch("/api/register", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,password})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "ok") {
            closeLogin();      // закрываем окно логина
            updateUIAfterLogin(data.user);
        } else {
            alert(data.message);
        }
    });
}

// ЛОГАУТ
function logout() {
    fetch("/logout").then(() => {
        document.getElementById("currentUser").textContent = "";
        const btn = document.getElementById("loginBtn");
        btn.textContent = "Log In";
        btn.onclick = openLogin;

        // выключаем кнопку выбора трекеров
        document.getElementById("selectTrackersBtn").disabled = true;
        closeAllPanels();           // закрываем все панели

        // очищаем список трекеров
        document.getElementById("trekersFilter").innerHTML = "";

        // очищаем карту + список
        refreshUserData(null);      // карта Киев, список пуст
    });
}

function updateUIAfterLogin(user) {
    document.getElementById("currentUser").textContent = "Logged in as: " + user.username;

    const btn = document.getElementById("loginBtn");
    btn.textContent = "Log Out";
    btn.onclick = logout;
    document.getElementById("selectTrackersBtn").disabled = false;

    refreshUserData(user.id);  // ← вместо showPoints + updateMap
    loadTrekers(user.id);   // <<< ЗАПУСКАЕМ формирование списка трекеров по данному пользователю
    loadTrekersPopup(user.id);
    currentUser = user;
}

</script>

<!-- ========================================================= -->
<!-- =============== ИНИЦИАЛИЗАЦИЯ СТРАНИЦЫ ================== -->
<!-- ========================================================= -->
<script>
// === ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ ===
(async () => {
    const info = await fetch("/whoami").then(r => r.json());

    if (!info.user) {
        // нет пользователя → пустой список и карта Киев
        refreshUserData(null);
        return;
    }

    updateUIAfterLogin(info.user);  // сам вызовет refreshUserData
})();

// === Открыть/Закрыть фильтр трекеров ===
function toggleFilterPanel() {
    const panel = document.getElementById("trekers-panel");
    const isVisible = panel.style.display === "block";

    closeAllPanels();           // закрываем все панели перед открытием

    if (!isVisible) {           // если панель была закрыта → открываем
        panel.style.display = "block";
    } // если была открыта → просто закроется
}

async function loadTrekers(userId) {
    if (!userId) {
        document.getElementById("trekersFilter").innerHTML = "";
        return;
    }

    const res = await fetch(`/api/trackers?user_id=${userId}`);
    const data = await res.json();

    const select = document.getElementById("trekersFilter");
    select.innerHTML = "";

    // пункт "All"
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "All trekers";
    select.appendChild(optAll);

    data.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.tracker_name;
        select.appendChild(opt);
    });
}


// === GLOBAL USER HOLDER (установить при логине / инициализации) ===
// let currentUser = null;

// Убедись, что updateUIAfterLogin устанавливает currentUser:
// function updateUIAfterLogin(user) {
//   currentUser = user;
//   ...
// }

// --- Haversine distance (km) ---
function haversineKm(lat1, lon1, lat2, lon2) {
    const toRad = deg => deg * Math.PI / 180;
    const R = 6371; // km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// --- Утилиты парсинга даты/времени ---
function combineDateTime(dateStr, timeStr) {
    // dateStr: YYYY-MM-DD, timeStr: HH:MM
    if (!dateStr) return null;
    const t = (timeStr && timeStr.length >= 4) ? timeStr : "00:00";
    return new Date(dateStr + "T" + t + ":00");
}

// --- Форматирование дистанции ---
function fmtKm(v) {
    if (v == null) return "0км";
    return `${(Math.round(v*10)/10).toLocaleString('ru-RU')}км`; // 1 decimal
}

// === APPLY FILTERS ===
async function applyFilters() {
    // 1) Проверки
    if (!currentUser || !currentUser.id) {
        alert("Пользователь не определён. Войдите в систему.");
        return;
    }

    // 2) Собираем параметры фильтра
    const select = document.getElementById("trekersFilter");
    const selectedOptions = Array.from(select.selectedOptions).map(o => o.value).filter(v => v !== "");
    const useAllTrackers = (selectedOptions.length === 0 || (selectedOptions.length === 1 && selectedOptions[0] === ""));

    const dateFrom = document.getElementById("dateFromFilter").value || null; // YYYY-MM-DD or ""
    const dateTo   = document.getElementById("dateToFilter").value   || null;
    const timeFrom = document.getElementById("timeFromFilter").value || null; // HH:MM
    const timeTo   = document.getElementById("timeToFilter").value   || null;
    const status   = document.getElementById("statusFilter").value; // "" or "1" or "0"

    // 3) Загружаем все точки пользователя (points_new содержит tracker_id и tracker_name)
    let resp = await fetch(`/api/points_new?user_id=${encodeURIComponent(currentUser.id)}`);
    let points = await resp.json();

    // 4) Фильтрация по выбранным трекерам
    if (!useAllTrackers) {
        const idsInt = selectedOptions.map(v => parseInt(v,10));
        points = points.filter(p => idsInt.includes(Number(p.tracker_id)));
    }

    // 5) Фильтрация по датам/времени и статусу
    points = points.filter(p => {
        // p.date = 'YYYY-MM-DD', p.time = 'HH:MM:SS' or 'HH:MM'
        const pDate = p.date || null;
        const pTimeRaw = p.time ? p.time.slice(0,5) : "00:00"; // keep HH:MM
        // date filter
        if (dateFrom && pDate < dateFrom) return false;
        if (dateTo && pDate > dateTo) return false;
        // time filter
        if (timeFrom && pTimeRaw < timeFrom) return false;
        if (timeTo && pTimeRaw > timeTo) return false;
        // status filter
        if (status !== "" && status !== null) {
            if (String(p.is_active) !== String(status)) return false;
        }
        return true;
    });

    // 6) Обновляем карту — показываем все отфильтрованные точки
    // подготовим точки в формате updateMap ожидает (lat, lon, tracker_name, date, time, is_active, id, tracker_id)
    const mapPoints = points.map(p => ({
        id: p.id,
        tracker_name: p.tracker_name || ("trk_" + p.tracker_id),
        lat: p.lat,
        lon: p.lon,
        date: p.date,
        time: (p.time || "").slice(0,5),
        is_active: p.is_active
    }));
    updateMap(mapPoints);

    // 7) Группировка по tracker_id для статистики
    const groups = {}; // tracker_id -> { tracker_name, pts: [p,...] }
    points.forEach(p => {
        const tid = String(p.tracker_id);
        if (!groups[tid]) groups[tid] = { tracker_name: p.tracker_name || ("trk_"+tid), pts: [] };
        groups[tid].pts.push(p);
    });

    // 8) Для каждой группы считаем требуемые поля
    const listBox = document.getElementById("pointsList");
    listBox.innerHTML = "";

    Object.keys(groups).forEach(tid => {
        const g = groups[tid];
        // сорт по дате+time (точки уже от API сортированы, но на всякий)
        g.pts.sort((a,b) => {
            const ta = (a.date || "") + " " + ((a.time||"00:00:00").slice(0,5));
            const tb = (b.date || "") + " " + ((b.time||"00:00:00").slice(0,5));
            return ta < tb ? -1 : (ta > tb ? 1 : 0);
        });

        // период дат и времени (по минимуму и максимуму)
        const dates = g.pts.map(p => p.date).filter(Boolean);
        const times = g.pts.map(p => (p.time||"00:00:00").slice(0,5)).filter(Boolean);
        const minDate = dates.length ? dates[0] : "";
        const maxDate = dates.length ? dates[dates.length-1] : "";
        const minTime = times.length ? times[0] : "00:00";
        const maxTime = times.length ? times[times.length-1] : "00:00";

        // считаем только активные точки для quantity и distance
        const activePts = g.pts.filter(p => Number(p.is_active) === 1);

        // quantity
        const quantity = activePts.length;

        // distance: суммируем расстояние между последовательными активными точками
        let distanceKm = 0;
        for (let i = 1; i < activePts.length; i++) {
            const a = activePts[i-1], b = activePts[i];
            if ((a.lat == null) || (b.lat == null) || (a.lon==null) || (b.lon==null)) continue;
            distanceKm += haversineKm(Number(a.lat), Number(a.lon), Number(b.lat), Number(b.lon));
        }

        // формируем строку
        const rowDiv = document.createElement("div");
        rowDiv.style.padding = "6px 4px";
        rowDiv.style.borderBottom = "1px solid #eee";
        rowDiv.textContent =
            `ID: ${tid}, Tracker: ${g.tracker_name}, ` +
            `Date: ${minDate || "-"} --> ${maxDate || "-"}, ` +
            `Time: ${minTime} --> ${maxTime}, ` +
            `quantity - ${quantity}, distance: ${fmtKm(distanceKm)}`;

        listBox.appendChild(rowDiv);
    });

    // 9) Если нет групп (ни один трекер) — показываем сообщение
    if (Object.keys(groups).length === 0) {
        listBox.innerHTML = "<div style='color:#666;padding:6px'>Нет точек по заданному фильтру</div>";
    }

    // 10) Закрываем панель (опционально)
    // document.getElementById("trekers-panel").style.display = "none";
}


</script>



{% endblock %}












