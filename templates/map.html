{% extends "base.html" %}

{% block title %}
<title>GPS точки</title>
{% endblock %}

{% block body %}

<!-- Кнопка открытия панели фильтров -->
<button id="filter-toggle" class="filter-button">☰</button>

<!-- Панель фильтра -->
<div id="filter-panel" class="filter-panel">
  <h5>Фильтр точек</h5>

  <!-- Пользователи -->
  <label for="userFilter">Пользователи</label>
  <select id="userFilter" multiple>
    <option value="" selected>Все пользователи</option>
  </select>

  <!-- Дата и время -->
  <label>From date/time</label>
  <input type="date" id="dateFromFilter">
  <input type="time" id="timeFromFilter">

  <label>To date/time</label>
  <input type="date" id="dateToFilter">
  <input type="time" id="timeToFilter">

  <!-- Статус -->
  <label for="statusFilter">Статус</label>
  <select id="statusFilter">
    <option value="">Все статусы</option>
    <option value="1">Активные</option>
    <option value="0">Пассивные</option>
  </select>

  <button onclick="applyFilters()">Найти</button>
</div>

<!-- Контейнер карты -->
<div id="map"></div>

<!-- Leaflet + MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<!-- Ваш CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css') }}">

<script>
  // --- Toggle панели фильтра ---
  const filterToggle = document.getElementById('filter-toggle');
  const filterPanel = document.getElementById('filter-panel');
  filterToggle.addEventListener('click', () => {
    filterPanel.classList.toggle('show');
  });

  // --- Инициализация карты ---
  const map = L.map('map').setView([55.751244, 37.618423], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // --- Кластеризация ---
  const markersLayer = L.markerClusterGroup().addTo(map);

  function updateMap(points) {
    markersLayer.clearLayers();
    points.forEach(pt => {
      const marker = L.marker([pt.lat, pt.lon])
        .bindPopup(`<b>ID:</b> ${pt.id}<br><b>Пользователь:</b> ${pt.user_id}<br><b>Статус:</b> ${pt.is_active ? "Активный" : "Пассивный"}`);
      markersLayer.addLayer(marker);
    });
    if (points.length > 0) {
      map.fitBounds(markersLayer.getBounds(), { padding: [50,50] });
    }
  }

  // --- Загрузка всех точек ---
  async function loadAllPoints() {
    try {
      const response = await fetch('/api/points');
      const data = await response.json();
      updateMap(data);
    } catch (err) {
      console.error("Ошибка при загрузке точек:", err);
    }
  }

  // --- Подгрузка пользователей ---
  async function loadUsers() {
    try {
      const response = await fetch('/api/users');
      const users = await response.json();
      const userSelect = document.getElementById('userFilter');

      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u;
        opt.textContent = u;
        userSelect.appendChild(opt);
      });
    } catch (err) {
      console.error("Ошибка при загрузке пользователей:", err);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    loadAllPoints();
  });

  // --- Применение фильтров ---
  async function applyFilters() {
    const userSelect = document.getElementById('userFilter');
    const selectedUsers = Array.from(userSelect.selectedOptions).map(o => o.value).filter(v=>v!=="");

    const params = new URLSearchParams();
    selectedUsers.forEach(u => params.append('user_id', u));

    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;
    const timeFrom = document.getElementById('timeFromFilter').value;
    const timeTo = document.getElementById('timeToFilter').value;
    const status = document.getElementById('statusFilter').value;

    if(dateFrom) params.append('date_from', dateFrom);
    if(dateTo) params.append('date_to', dateTo);
    if(timeFrom) params.append('time_from', timeFrom);
    if(timeTo) params.append('time_to', timeTo);
    if(status!=="") params.append('is_active', status);

    try {
      const response = await fetch('/api/points?' + params.toString());
      const data = await response.json();
      updateMap(data);
    } catch(err) {
      console.error("Ошибка при фильтрации:", err);
    }
  }
</script>

{% endblock %}





















