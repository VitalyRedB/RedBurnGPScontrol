{% extends "base.html" %}

{% block title %}
<title>GPS точки</title>
{% endblock %}

{% block body %}

<!-- === КНОПКИ УПРАВЛЕНИЯ === -->
<button id="filter-toggle" class="filter-button">☰</button>
<button id="line-toggle" class="filter-button">L</button>

<!-- === ПАНЕЛЬ ФИЛЬТРА === -->
<div id="filter-panel" class="filter-panel">
  <h5>Фильтр точек</h5>
  <label for="userFilter">Пользователи</label>
  <select id="userFilter" multiple>
    <option value="" selected>Все пользователи</option>
  </select>

  <label>From date/time</label>
  <input type="date" id="dateFromFilter">
  <input type="time" id="timeFromFilter">

  <label>To date/time</label>
  <input type="date" id="dateToFilter">
  <input type="time" id="timeToFilter">

  <label for="statusFilter">Статус</label>
  <select id="statusFilter">
    <option value="">Все статусы</option>
    <option value="1">Активные</option>
    <option value="0">Пассивные</option>
  </select>

  <button onclick="applyFilters()">Найти</button>
</div>

<!-- === ПАНЕЛЬ ЛИНИЙ (ОБЪЕДИНЕНИЕ ТОЧЕК) === -->
<div id="line-panel" class="filter-panel">
  <h5 style="text-indent: 40px;">Объединение точек</h5>
  <label for="lineUser">Пользователь</label>
  <select id="lineUser">
    <option value="" selected>Выберите пользователя</option>
  </select>

  <label>From date</label>
  <input type="date" id="lineDateFrom">
  <label>To date</label>
  <input type="date" id="lineDateTo">

  <button id="mergeLines" class="btn btn-primary mt-2">Объединить</button>
</div>

<!-- === КАРТА === -->
<div id="map"></div>

<!-- === Leaflet + MarkerCluster === -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<!-- === CSS === -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css') }}">

<script>
  // === Панели ===
  const filterToggle = document.getElementById('filter-toggle');
  const lineToggle = document.getElementById('line-toggle');
  const filterPanel = document.getElementById('filter-panel');
  const linePanel = document.getElementById('line-panel');

  // --- Адаптивное открытие ---
  function togglePanel(panel, otherPanel) {
    // если в мобильной версии — просто выезжают снизу
    const isMobile = window.innerWidth <= 768;

    // Если панель уже открыта — закрываем её
    if (panel.classList.contains('show')) {
      panel.classList.remove('show');
    } else {
      // Закрываем другую панель и открываем эту
      if (otherPanel) otherPanel.classList.remove('show');
      panel.classList.add('show');
    }
  }

  // --- Обработчики кнопок ---
  filterToggle.addEventListener('click', () => togglePanel(filterPanel, linePanel));
  lineToggle.addEventListener('click', () => togglePanel(linePanel, filterPanel));

  // === Инициализация карты ===
  const map = L.map('map').setView([50.45, 30.52], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // === Кластеризация ===
  const markersLayer = L.markerClusterGroup().addTo(map);
  const linesLayer = L.layerGroup().addTo(map);

  let allPoints = [];
  let linesVisible = false;
  let popupGroup = [];

  // === Обновление карты ===
  function updateMap(points) {
    markersLayer.clearLayers();
    points.forEach(pt => {
      const marker = L.marker([pt.lat, pt.lon]);

      const popupContent = document.createElement('div');
      popupContent.innerHTML = `
        <b>ID:</b> ${pt.id}<br>
        <b>Пользователь:</b> ${pt.user_id}<br>
        <b>Статус:</b> ${pt.is_active ? "Активный" : "Пассивный"}<br>
        <b>Дата/Время:</b> ${pt.date} ${pt.time}<br>
        <button class="get-address-btn">Показать адрес</button>
        <div class="address"></div>
      `;
      marker.bindPopup(popupContent);

      // --- при открытии popup ---
      marker.on('popupopen', () => {
        const btn = popupContent.querySelector('.get-address-btn');
        const addrDiv = popupContent.querySelector('.address');
        btn.addEventListener('click', async () => {
          addrDiv.innerHTML = "Загрузка...";
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pt.lat}&lon=${pt.lon}&format=json`);
            const data = await res.json();
            addrDiv.innerHTML = data.display_name || "Не найдено";
          } catch {
            addrDiv.innerHTML = "Ошибка запроса";
          }
        }, { once: true });
      });

      markersLayer.addLayer(marker);
    });

    if (points.length > 0) map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
  }

  // === Загрузка точек ===
  async function loadAllPoints() {
    try {
      const res = await fetch('/api/points');
      allPoints = await res.json();
      updateMap(allPoints);
    } catch (err) {
      console.error("Ошибка при загрузке точек:", err);
    }
  }

  // === Загрузка пользователей ===
  async function loadUsers() {
    try {
      const res = await fetch('/api/users');
      const users = await res.json();
      const userSelect = document.getElementById('userFilter');
      const lineUserSelect = document.getElementById('lineUser');

      users.forEach(u => {
        const opt1 = new Option(u, u);
        const opt2 = new Option(u, u);
        userSelect.add(opt1);
        lineUserSelect.add(opt2);
      });
    } catch (err) {
      console.error("Ошибка при загрузке пользователей:", err);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    loadAllPoints();
  });

  // === Фильтры ===
  async function applyFilters() {
    const selectedUsers = Array.from(document.getElementById('userFilter').selectedOptions)
      .map(o => o.value)
      .filter(v => v !== "");

    const params = new URLSearchParams();
    selectedUsers.forEach(u => params.append('user_id', u));

    const fields = [
      ['date_from', 'dateFromFilter'],
      ['date_to', 'dateToFilter'],
      ['time_from', 'timeFromFilter'],
      ['time_to', 'timeToFilter']
    ];

    for (const [param, id] of fields) {
      const val = document.getElementById(id).value;
      if (val) params.append(param, val);
    }

    const status = document.getElementById('statusFilter').value;
    if (status !== "") params.append('is_active', status);

    try {
      const res = await fetch('/api/points?' + params.toString());
      const data = await res.json();
      updateMap(data);
    } catch (err) {
      console.error("Ошибка при фильтрации:", err);
    }
  }

  // === Построение линий ===
  async function toggleLinesForUser(userId, dateFrom, dateTo) {
    const mergeBtn = document.getElementById('mergeLines');

    if (linesVisible) {
      // выключаем режим
      linesLayer.clearLayers();
      popupGroup.forEach(p => map.removeLayer(p));
      popupGroup = [];
      linesVisible = false;
      mergeBtn.textContent = "Объединить";
      mergeBtn.style.backgroundColor = "";
      updateMap(allPoints);
      return;
    }

    if (!userId) return;

    const params = new URLSearchParams({ user_id: userId });
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);

    try {
      const res = await fetch('/api/points?' + params.toString());
      const data = await res.json();
      if (data.length === 0) return;

      updateMap(data);

      const pointsByDate = {};
      data.forEach(pt => {
        (pointsByDate[pt.date] ||= []).push(pt);
      });

      Object.keys(pointsByDate).forEach(date => {
        const dayPoints = pointsByDate[date].sort((a, b) => a.time.localeCompare(b.time));
        const latlngs = dayPoints.map(p => [p.lat, p.lon]);

        const line = L.polyline(latlngs, { color: 'red', weight: 4 }).addTo(linesLayer);

        let dist = 0;
        for (let i = 1; i < latlngs.length; i++) dist += map.distance(latlngs[i - 1], latlngs[i]);
        dist /= 1000;

        const popup = L.popup({ closeButton: false, autoClose: false })
          .setLatLng(line.getBounds().getCenter())
          .setContent(`${userId} — ${dayPoints.length} точек, ${dist.toFixed(2)} км`)
          .openOn(map);
        popupGroup.push(popup);
      });

      mergeBtn.textContent = "Отменить";
      mergeBtn.style.backgroundColor = "blue";
      linesVisible = true;
    } catch (err) {
      console.error("Ошибка при построении линий:", err);
    }
  }

  // === Кнопка объединения ===
  const mergeBtn = document.getElementById('mergeLines');
  mergeBtn.addEventListener('click', () => {
    const userId = document.getElementById('lineUser').value;
    const dateFrom = document.getElementById('lineDateFrom').value;
    const dateTo = document.getElementById('lineDateTo').value;
    toggleLinesForUser(userId, dateFrom, dateTo);
  });
</script>


{% endblock %}
























