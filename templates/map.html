{% extends "base.html" %}

{% block title %}
<title>GPS —Ç–æ—á–∫–∏</title>
{% endblock %}

{% block body %}

<!-- === –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø === -->
<button id="filter-toggle" class="filter-button">‚ò∞</button>
<button id="line-toggle" class="filter-button">L</button>
<button id="admin-btn" class="filter-button">A</button>

<!-- === –ü–ê–ù–ï–õ–¨ –§–ò–õ–¨–¢–†–ê === -->
<div id="filter-panel" class="filter-panel">
  <h5>–§–∏–ª—å—Ç—Ä —Ç–æ—á–µ–∫</h5>
  <label for="userFilter">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
  <select id="userFilter" multiple>
    <option value="" selected>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
  </select>

  <label>From date/time  ‚Üí To date/time</label>
  <div class="date-time-container">
    <div class="date-time-block">
      <input type="date" id="dateFromFilter">
      <input type="time" id="timeFromFilter">
    </div>
    <div class="date-time-block">
      <input type="date" id="dateToFilter">
      <input type="time" id="timeToFilter">
    </div>
  </div>

  <label for="statusFilter">Status points</label>
  <select id="statusFilter">
    <option value="">All points</option>
    <option value="1">Active points</option>
    <option value="0">Passive points</option>
  </select>

  <button onclick="applyFilters()" class="btn btn-primary mt-2">–ù–∞–π—Ç–∏</button>
</div>

<!-- === –ü–ê–ù–ï–õ–¨ –õ–ò–ù–ò–ô === -->
<div id="line-panel" class="filter-panel">
  <h5>_______________in line</h5>
  <h5>–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–æ—á–µ–∫</h5>
  <label for="lineUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
  <select id="lineUser">
    <option value="" selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
  </select>

  <label>From date</label>
  <input type="date" id="lineDateFrom">
  <label>To date</label>
  <input type="date" id="lineDateTo">

  <button id="mergeLines" class="btn btn-primary mt-2">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button>
  <div id="total-distance" style="margin-top:10px; font-weight:bold; color:blue;"></div>
</div>

<!-- === –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê === -->
<div id="admin-panel" class="filter-panel">
  <h5>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h5>
  <button id="select-all-btn" class="action-btn">Select All points</button>
  <button id="change-status-btn" class="btn btn-primary mt-2">Change status</button>
  <button id="delete-btn" class="btn btn-primary mt-2">Delete points</button>
  <button id="send-report-btn" class="btn btn-primary mt-2" disabled>Send report</button>
</div>

<!-- === –ö–ê–†–¢–ê === -->
<div id="map"></div>

<!-- === –õ–ï–ì–ï–ù–î–ê –¶–í–ï–¢–û–í === -->
<div id="legend" class="map-legend">
  <b>Legend:</b><br>
  üü¢ Active points<br>
  üî¥ Passive points<br>
  üü° Selected points
</div>

<!-- === Leaflet + MarkerCluster === -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>


<!-- === CSS === -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css') }}">

<script>
  // ===================================================
  // === 1. –ü–ê–ù–ï–õ–ò –§–ò–õ–¨–¢–†–ê, –õ–ò–ù–ò–ô –ò –ê–î–ú–ò–ù–ê ============
  // ===================================================
  const filterToggle = document.getElementById('filter-toggle');
  const lineToggle = document.getElementById('line-toggle');
  const adminBtn = document.getElementById('admin-btn');

  const filterPanel = document.getElementById('filter-panel');
  const linePanel = document.getElementById('line-panel');
  const adminPanel = document.getElementById('admin-panel');

  function togglePanel(panel, otherPanels) {
    if (!Array.isArray(otherPanels)) otherPanels = [otherPanels].filter(Boolean);
    if (panel.classList.contains('show')) {
      panel.classList.remove('show');
    } else {
      otherPanels.forEach(p => p.classList.remove('show'));
      panel.classList.add('show');
    }
  }

  filterToggle.addEventListener('click', () => togglePanel(filterPanel, [linePanel, adminPanel]));
  lineToggle.addEventListener('click', () => togglePanel(linePanel, [filterPanel, adminPanel]));
  adminBtn.addEventListener('click', () => togglePanel(adminPanel, [filterPanel, linePanel]));

  // ===================================================
  // === 2. –ö–ê–†–¢–ê LEAFLET ===============================
  // ===================================================
  const map = L.map('map').setView([50.45, 30.52], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // MarkerClusterGroup - –º–∞—Ä–∫–µ—Ä—ã –¥–æ–±–∞–≤–ª—è–µ–º —Å—é–¥–∞
  const markersLayer = L.markerClusterGroup().addTo(map);
  const linesLayer = L.layerGroup().addTo(map);

  let allPoints = [];           // –≤—Å–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ (–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
  let selectedPoints = [];      // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ç–æ—á–∫–∏
  let linesVisible = false;
  let popupGroup = [];

  // === –ò–∫–æ–Ω–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º CDN-—Ü–≤–µ—Ç–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏) ===
  const activeIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  const passiveIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  const selectedIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  // ===================================================
  // === 3. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–ß–ï–ö –ù–ê –ö–ê–†–¢–ï =================
  // ===================================================
  function updateMap(points) {
    // –û—á–∏—â–∞–µ–º —Å–ª–æ–π –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    markersLayer.clearLayers();
    window.pointMarkers = []; // —Ö—Ä–∞–Ω–∏–º –æ–±—ä–µ–∫—Ç—ã —Ç–æ—á–µ–∫ —Å –º–∞—Ä–∫–µ—Ä–æ–º
    selectedPoints = [];

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–∏–º—ã–µ —Ç–æ—á–∫–∏ (–Ω—É–∂–Ω–æ –¥–ª—è Select All –∏ –¥—Ä.)
    allPoints = points;

    // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –æ–¥–∏–Ω —Å—Ç–∞—Ç—É—Å (1 –∏–ª–∏ 0)
    const statusFilter = document.getElementById('statusFilter').value;
    const allowSelection = (statusFilter === "1" || statusFilter === "0");

    points.forEach(pt => {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ is_active –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      // NOTE: –≤ —Å—Ç–∞—Ä–æ–º –∫–æ–¥–µ –±—ã–ª–æ –ø–æ–ª–µ status ‚Äî —Ç–µ–ø–µ—Ä—å —Ç—Ä–µ–±—É—é is_active –≤–µ–∑–¥–µ
      const icon = (pt.is_active === 1 || pt.is_active === true) ? activeIcon : passiveIcon;

      // –°–æ–∑–¥–∞—ë–º –º–∞—Ä–∫–µ—Ä –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–ª–∞—Å—Ç–µ—Ä
      const marker = L.marker([pt.lat, pt.lon], { icon });
      marker.addTo(markersLayer);

      // –°–≤—è–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –∏ —Ç–æ—á–∫—É
      pt.marker = marker;
      window.pointMarkers.push(pt);

      // === POPUP ===
      const popupContent = document.createElement('div');
      popupContent.classList.add('popup-content');
      popupContent.innerHTML = `
        <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${pt.user_id}<br>
        <b>–î–∞—Ç–∞:</b> ${pt.date} ${pt.time}<br>
        <b>–°—Ç–∞—Ç—É—Å:</b> ${(pt.is_active === 1 || pt.is_active === true) ? "–ê–∫—Ç–∏–≤–Ω—ã–π" : "–ü–∞—Å—Å–∏–≤–Ω—ã–π"}<br>
        <button class="get-address-btn">–ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å</button>
        <button class="change-status-btn">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <div class="address"></div>
      `;

      marker.bindPopup(popupContent);

      // === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê ===
      marker.on('click', () => {
        // –ï—Å–ª–∏ –ø–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ —Ç–æ—á–∫–∏ ‚Äî –≤—ã–±–∏—Ä–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º popup
        if (!allowSelection) {
          marker.openPopup();
          return;
        }

        const idx = selectedPoints.findIndex(p => p.id === pt.id);
        if (idx >= 0) {
          // —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          selectedPoints.splice(idx, 1);
          marker.setIcon((pt.is_active === 1 || pt.is_active === true) ? activeIcon : passiveIcon);
        } else {
          // –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          selectedPoints.push(pt);
          marker.setIcon(selectedIcon);
        }
      });

      // === –ö–ù–û–ü–ö–ò POPUP ===
      marker.on('popupopen', () => {
        const addrBtn = popupContent.querySelector('.get-address-btn');
        const changeBtn = popupContent.querySelector('.change-status-btn');
        const addrDiv = popupContent.querySelector('.address');

        // –ü–æ–∫–∞–∑ –∞–¥—Ä–µ—Å–∞ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ OpenStreetMap Nominatim
        if (addrBtn) {
          addrBtn.addEventListener('click', async () => {
            addrDiv.textContent = "–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...";
            try {
              const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pt.lat}&lon=${pt.lon}&format=json&accept-language=ru`);
              const data = await res.json();
              addrDiv.textContent = data.display_name || "–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
            } catch (err) {
              addrDiv.textContent = "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞";
              console.error(err);
            }
          }, { once: true });
        }


        // –ö–Ω–æ–ø–∫–∞ "–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å" –¥–ª—è –æ–¥–Ω–æ–π —Ç–æ—á–∫–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º —Ä–µ–∂–∏–º–µ)
        if (changeBtn) {
          changeBtn.addEventListener('click', async () => {
            // –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å (—Å–µ—Ä–≤–µ—Ä —Ç–æ–∂–µ –¥–µ–ª–∞–µ—Ç toggle)
            const newStatusLocal = (pt.is_active === 1 || pt.is_active === true) ? 0 : 1;
            try {
              const res = await fetch('/change_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: [pt.id] }) // –±–µ–∫–µ–Ω–¥ —É —Ç–µ–±—è –¥–µ–ª–∞–µ—Ç toggle
              });
              const data = await res.json();
              if (data.success) {
                // –ú–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∏–∫–æ–Ω–∫—É –∏ –ø–æ–ª–µ is_active
                pt.is_active = newStatusLocal;
                marker.setIcon(pt.is_active === 1 ? activeIcon : passiveIcon);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ popup (—á—Ç–æ–±—ã —Å—Ç–∞—Ç—É—Å –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ–º–µ–Ω—è–ª—Å—è)
                popupContent.querySelectorAll('b')[2].nextSibling && (popupContent.querySelectorAll('b')[2].nextSibling.nodeValue = ` ${pt.is_active === 1 ? "–ê–∫—Ç–∏–≤–Ω—ã–π" : "–ü–∞—Å—Å–∏–≤–Ω—ã–π"}`);
                // –ï—Å–ª–∏ –ø—Ä–æ—â–µ ‚Äî –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å innerHTML —Å—Ç–∞—Ç—É—Å–∞, –Ω–æ —Ç—É—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
                alert("–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω");
              } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞");
              }
            } catch (err) {
              alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
              console.error(err);
            }
          }, { once: true });
        }
      });
    });

    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ–¥ –º–∞—Ä–∫–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (points.length > 0) {
      try {
        map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
      } catch (e) {
        // –µ—Å–ª–∏ –æ–¥–∏–Ω –º–∞—Ä–∫–µ—Ä ‚Äî fitBounds –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å; –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
      }
    }
  }

  // ===================================================
  // === 4. –ó–ê–ì–†–£–ó–ö–ê –¢–û–ß–ï–ö –ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ============
  // ===================================================
  async function loadAllPoints() {
    try {
      const res = await fetch('/api/points');
      const data = await res.json();
      updateMap(data);
    } catch (err) { console.error(err); }
  }

  async function loadUsers() {
    try {
      const res = await fetch('/api/users');
      const users = await res.json();
      const userSelect = document.getElementById('userFilter');
      const lineUserSelect = document.getElementById('lineUser');
      users.forEach(u => {
        userSelect.add(new Option(u, u));
        lineUserSelect.add(new Option(u, u));
      });
    } catch (err) { console.error(err); }
  }

  window.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    loadAllPoints();
  });

  // ===================================================
  // === 5. –§–ò–õ–¨–¢–†–´ ================================
  // ===================================================
  async function applyFilters() {
    const selectedUsers = Array.from(document.getElementById('userFilter').selectedOptions)
      .map(o => o.value).filter(v => v !== "");

    const params = new URLSearchParams();
    selectedUsers.forEach(u => params.append('user_id', u));

    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;
    const timeFrom = document.getElementById('timeFromFilter').value;
    const timeTo = document.getElementById('timeToFilter').value;

    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    if (timeFrom) params.append('time_from', timeFrom);
    if (timeTo) params.append('time_to', timeTo);

    const status = document.getElementById('statusFilter').value;
    if (status !== "") params.append('is_active', status);

    try {
      const res = await fetch('/api/points?' + params.toString());
      const data = await res.json();
      updateMap(data);
    } catch (err) {
      console.error(err);
    }
  }

  // ===================================================
  // === 6. –õ–ò–ù–ò–ò ================================
  // ===================================================
  const mergeBtn = document.getElementById('mergeLines');
  mergeBtn.addEventListener('click', () => {
    const userId = document.getElementById('lineUser').value;
    const dateFrom = document.getElementById('lineDateFrom').value;
    const dateTo = document.getElementById('lineDateTo').value;
    toggleLinesForUser(userId, dateFrom, dateTo);
  });


    async function toggleLinesForUser(userId, dateFrom, dateTo) {
          const totalDistanceEl = document.getElementById('total-distance'); // —Å—é–¥–∞ –∑–∞–ø–∏—à–µ–º –∏—Ç–æ–≥

        if (linesVisible) {
            linesLayer.clearLayers();
            popupGroup.forEach(p => map.removeLayer(p));
            popupGroup = [];
            linesVisible = false;
            mergeBtn.textContent = "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å";
            mergeBtn.style.backgroundColor = "";
            totalDistanceEl.textContent = ""; // –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
            updateMap(allPoints);
            return;
        }

        if (!userId) return;

          const params = new URLSearchParams({ user_id: userId });
          if (dateFrom) params.append('date_from', dateFrom);
          if (dateTo) params.append('date_to', dateTo);

          try {
            const res = await fetch('/api/points?' + params.toString());
            const data = await res.json();
            if (!data.length) return;

            updateMap(data);

            let totalDistance = 0;
            const pointsByDate = {};
            data.forEach(pt => (pointsByDate[pt.date] ||= []).push(pt));

            Object.keys(pointsByDate).forEach(date => {
              const dayPoints = pointsByDate[date].sort((a, b) => a.time.localeCompare(b.time));
              const latlngs = dayPoints.map(p => [p.lat, p.lon]);
              const line = L.polyline(latlngs, { color: 'red', weight: 4 }).addTo(linesLayer);

              // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
              for (let i = 1; i < latlngs.length; i++) {
                const dist = map.distance(latlngs[i - 1], latlngs[i]) / 1000;
                totalDistance += dist;

                // –≤—Å–ø–ª—ã–≤–∞—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                const mid = [
                  (latlngs[i - 1][0] + latlngs[i][0]) / 2,
                  (latlngs[i - 1][1] + latlngs[i][1]) / 2
                ];
                const segmentLine = L.polyline([latlngs[i - 1], latlngs[i]], { color: 'transparent' }).addTo(linesLayer);
                segmentLine.bindTooltip(`${dist.toFixed(2)} –∫–º`, { permanent: false, sticky: true });
              }

              const popup = L.popup({ closeButton: false, autoClose: false })
                .setLatLng(line.getBounds().getCenter())
                .setContent(`${userId} ‚Äî ${dayPoints.length} —Ç–æ—á–µ–∫`)
                .openOn(map);
              popupGroup.push(popup);
            });

            totalDistanceEl.textContent = `–û–±—â–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è: ${totalDistance.toFixed(2)} –∫–º`;
            mergeBtn.textContent = "–û—Ç–º–µ–Ω–∏—Ç—å";
            mergeBtn.style.backgroundColor = "blue";
            linesVisible = true;

          } catch (err) {
            console.error(err);
        }
    }


  // ===================================================
  // === 7. –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================
  // ===================================================

  // === 7.1 –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–æ—á–µ–∫ ===
  let allSelected = false;
  const selectAllBtn = document.getElementById('select-all-btn');

  selectAllBtn.addEventListener('click', () => {
    // –†–∞–∑—Ä–µ—à–∞–µ–º Select All —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –≤—ã–±–æ—Ä–∞ –æ–¥–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    const statusFilter = document.getElementById('statusFilter').value;
    const allowSelection = (statusFilter === "1" || statusFilter === "0");
    if (!allowSelection) {
      alert("Select All –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–¥–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (Active –∏–ª–∏ Passive).");
      return;
    }

    if (!allSelected) {
      selectedPoints = [...allPoints];
      selectedPoints.forEach(pt => pt.marker?.setIcon(selectedIcon));
      selectAllBtn.style.backgroundColor = "green";
    } else {
      selectedPoints.forEach(pt => pt.marker?.setIcon(pt.is_active === 1 ? activeIcon : passiveIcon));
      selectedPoints = [];
      selectAllBtn.style.backgroundColor = "";
    }
    allSelected = !allSelected;
  });

  // === 7.2 –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ ===
  const changeStatusBtn = document.getElementById('change-status-btn');

  changeStatusBtn.addEventListener('click', async () => {
    if (!selectedPoints.length) {
      alert("No points selected.");
      return;
    }

    // –õ–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É)
    selectedPoints.forEach(pt => {
      pt.is_active = (pt.is_active === 1 || pt.is_active === true) ? 0 : 1;
      pt.marker?.setIcon(pt.is_active === 1 ? activeIcon : passiveIcon);
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä: –±–µ–∫–µ–Ω–¥ —É —Ç–µ–±—è –¥–µ–ª–∞–µ—Ç toggle, –ø–æ—ç—Ç–æ–º—É –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ids
    try {
      const res = await fetch('/change_status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedPoints.map(p => p.id) })
      });
      const data = await res.json();
      if (!data.success) {
        alert("Error updating status on server.");
      }
    } catch (err) {
      alert("Server error while changing status.");
      console.error(err);
    }

    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    selectedPoints = [];
    allSelected = false;
    selectAllBtn.style.backgroundColor = "";
  });

  // === 7.3 –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ ===
  const deleteBtn = document.getElementById('delete-btn');

  deleteBtn.addEventListener('click', async () => {
    if (!selectedPoints.length) {
      alert("No points selected.");
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–∞—Å—Å–∏–≤–Ω—ã–µ
    if (!selectedPoints.every(pt => pt.is_active === 0)) {
      alert("You can only delete points with PASSIVE status.");
      return;
    }

    if (!confirm("Are you sure you want to delete these points?")) return;

    try {
      const res = await fetch('/delete_points', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedPoints.map(p => p.id) })
      });
      const data = await res.json();

      if (data.success) {
        // –£–¥–∞–ª—è–µ–º —Å –∫–∞—Ä—Ç—ã –∏ –∏–∑ –ø–∞–º—è—Ç–∏
        selectedPoints.forEach(pt => markersLayer.removeLayer(pt.marker));
        selectedPoints = [];
        allSelected = false;
        selectAllBtn.style.backgroundColor = "";
        alert("Points deleted successfully.");
      } else {
        alert("Error deleting points");
      }
    } catch (err) {
      alert("Server error while deleting points.");
      console.error(err);
    }
  });

</script>


<script>

</script>

{% endblock %}

























