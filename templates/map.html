{% extends "base.html" %}

{% block title %}
<title>GPS —Ç–æ—á–∫–∏</title>
{% endblock %}

{% block body %}

<!-- === –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø === -->
<button id="filter-toggle" class="filter-button">‚ò∞</button>
<button id="line-toggle" class="filter-button">L</button>
<button id="admin-btn" class="filter-button">A</button>

<!-- === –ü–ê–ù–ï–õ–¨ –§–ò–õ–¨–¢–†–ê === -->
<div id="filter-panel" class="filter-panel">
  <h5>–§–∏–ª—å—Ç—Ä —Ç–æ—á–µ–∫</h5>
  <label for="userFilter">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
  <select id="userFilter" multiple>
    <option value="" selected>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
  </select>

  <label>From date/time  ‚Üí To date/time</label>
  <div class="date-time-container">
    <div class="date-time-block">
      <input type="date" id="dateFromFilter">
      <input type="time" id="timeFromFilter">
    </div>
    <div class="date-time-block">
      <input type="date" id="dateToFilter">
      <input type="time" id="timeToFilter">
    </div>
  </div>

  <label for="statusFilter">Status points</label>
  <select id="statusFilter">
    <option value="">All points</option>
    <option value="1">Active points</option>
    <option value="0">Passive points</option>
  </select>

  <button onclick="applyFilters()" class="btn btn-primary mt-2">–ù–∞–π—Ç–∏</button>
</div>

<!-- === –ü–ê–ù–ï–õ–¨ –õ–ò–ù–ò–ô === -->
<div id="line-panel" class="filter-panel">
  <h5>_______________in line</h5>
  <h5>–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–æ—á–µ–∫</h5>
  <label for="lineUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
  <select id="lineUser">
    <option value="" selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
  </select>

  <label>From date</label>
  <input type="date" id="lineDateFrom">
  <label>To date</label>
  <input type="date" id="lineDateTo">

  <button id="mergeLines" class="btn btn-primary mt-2">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button>
</div>

<!-- === –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê === -->
<div id="admin-panel" class="filter-panel">
  <h5>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h5>
  <button id="select-all-btn" class="action-btn">Select All points</button>
  <button id="change-status-btn" class="btn btn-primary mt-2">Change status</button>
  <button id="delete-btn" class="btn btn-primary mt-2">Delete points</button>
  <button id="send-report-btn" class="btn btn-primary mt-2" disabled>Send report</button>
</div>

<!-- === –ö–ê–†–¢–ê === -->
<div id="map"></div>

<!-- === –õ–ï–ì–ï–ù–î–ê –¶–í–ï–¢–û–í === -->
<div id="legend" class="map-legend">
  <b>Legend:</b><br>
  üü¢ Active points<br>
  üî¥ Passive points<br>
  üü° Selected points
</div>

<!-- === Leaflet + MarkerCluster === -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>


<!-- === CSS === -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/filter.css') }}">

<script>
  // ===================================================
  // === 1. –ü–ê–ù–ï–õ–ò –§–ò–õ–¨–¢–†–ê, –õ–ò–ù–ò–ô –ò –ê–î–ú–ò–ù–ê ============
  // ===================================================
  const filterToggle = document.getElementById('filter-toggle');
  const lineToggle = document.getElementById('line-toggle');
  const adminBtn = document.getElementById('admin-btn');

  const filterPanel = document.getElementById('filter-panel');
  const linePanel = document.getElementById('line-panel');
  const adminPanel = document.getElementById('admin-panel');

  function togglePanel(panel, otherPanels) {
    if (!Array.isArray(otherPanels)) otherPanels = [otherPanels].filter(Boolean);
    if (panel.classList.contains('show')) {
      panel.classList.remove('show');
    } else {
      otherPanels.forEach(p => p.classList.remove('show'));
      panel.classList.add('show');
    }
  }

  filterToggle.addEventListener('click', () => togglePanel(filterPanel, [linePanel, adminPanel]));
  lineToggle.addEventListener('click', () => togglePanel(linePanel, [filterPanel, adminPanel]));
  adminBtn.addEventListener('click', () => togglePanel(adminPanel, [filterPanel, linePanel]));

  // ===================================================
  // === 2. –ö–ê–†–¢–ê LEAFLET ===============================
  // ===================================================
  const map = L.map('map').setView([50.45, 30.52], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const markersLayer = L.markerClusterGroup().addTo(map);
  const linesLayer = L.layerGroup().addTo(map);

  let allPoints = [];           // –≤—Å–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ (–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
  let selectedPoints = [];      // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ç–æ—á–∫–∏
  let linesVisible = false;
  let popupGroup = [];

  // === –ò–∫–æ–Ω–∫–∏ ===
//  const activeIcon = L.icon({ iconUrl: '/static/icons/green.png', iconSize: [25, 41], iconAnchor: [12, 41] });
//  const passiveIcon = L.icon({ iconUrl: '/static/icons/red.png', iconSize: [25, 41], iconAnchor: [12, 41] });
//  const selectedIcon = L.icon({ iconUrl: '/static/icons/yellow.png', iconSize: [25, 41], iconAnchor: [12, 41] });

    // === –ò–∫–æ–Ω–∫–∏ ===
  const activeIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  const passiveIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  const selectedIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });


  // ===================================================
  // === 3. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–ß–ï–ö –ù–ê –ö–ê–†–¢–ï =================
  // ===================================================
  function updateMap(points) {
    markersLayer.clearLayers();

    points.forEach(pt => {
      const marker = L.marker([pt.lat, pt.lon], { icon: pt.status===1 ? activeIcon : passiveIcon });
      pt.marker = marker; // —Å–≤—è–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –æ–±—ä–µ–∫—Ç–æ–º —Ç–æ—á–∫–∏

      const popupContent = document.createElement('div');
      popupContent.innerHTML = `
        <b>ID:</b> ${pt.id}<br>
        <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${pt.user_id}<br>
        <b>–°—Ç–∞—Ç—É—Å:</b> ${pt.status===1 ? "–ê–∫—Ç–∏–≤–Ω—ã–π" : "–ü–∞—Å—Å–∏–≤–Ω—ã–π"}<br>
        <b>–î–∞—Ç–∞/–í—Ä–µ–º—è:</b> ${pt.date} ${pt.time}<br>
        <button class="get-address-btn">–ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å</button>
        <div class="address"></div>
      `;
      marker.bindPopup(popupContent);

      // –ü–æ–∫–∞–∑ –∞–¥—Ä–µ—Å–∞
      marker.on('popupopen', () => {
        const btn = popupContent.querySelector('.get-address-btn');
        const addrDiv = popupContent.querySelector('.address');
        btn.addEventListener('click', async () => {
          addrDiv.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pt.lat}&lon=${pt.lon}&format=json`);
            const data = await res.json();
            addrDiv.innerHTML = data.display_name || "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
          } catch { addrDiv.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞"; }
        }, { once: true });
      });

      // === –í—ã–±–æ—Ä —Ç–æ—á–∫–∏ –≤—Ä—É—á–Ω—É—é ===
      marker.on('click', () => {
        const index = selectedPoints.findIndex(p => p.id === pt.id);
        if (index >= 0) {
          // —Å–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä
          selectedPoints.splice(index, 1);
          pt.marker.setIcon(pt.status===1 ? activeIcon : passiveIcon);
        } else {
          // –≤—ã–±–∏—Ä–∞–µ–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
          selectedPoints.push(pt);
          pt.marker.setIcon(selectedIcon);
        }
      });

      markersLayer.addLayer(marker);
    });

    allPoints = points; // –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –≤–∏–¥–∏–º—ã—Ö —Ç–æ—á–µ–∫
    if (points.length > 0) map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
  }

  // ===================================================
  // === 4. –ó–ê–ì–†–£–ó–ö–ê –¢–û–ß–ï–ö –ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ============
  // ===================================================
  async function loadAllPoints() {
    try {
      const res = await fetch('/api/points');
      const data = await res.json();
      updateMap(data);
    } catch (err) { console.error(err); }
  }

  async function loadUsers() {
    try {
      const res = await fetch('/api/users');
      const users = await res.json();
      const userSelect = document.getElementById('userFilter');
      const lineUserSelect = document.getElementById('lineUser');
      users.forEach(u => {
        userSelect.add(new Option(u, u));
        lineUserSelect.add(new Option(u, u));
      });
    } catch (err) { console.error(err); }
  }

  window.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    loadAllPoints();
  });

  // ===================================================
  // === 5. –§–ò–õ–¨–¢–†–´ ================================
  // ===================================================
    async function applyFilters() {
      const selectedUsers = Array.from(document.getElementById('userFilter').selectedOptions)
        .map(o => o.value).filter(v => v !== "");

      const params = new URLSearchParams();
      selectedUsers.forEach(u => params.append('user_id', u));

      const dateFrom = document.getElementById('dateFromFilter').value;
      const dateTo = document.getElementById('dateToFilter').value;
      const timeFrom = document.getElementById('timeFromFilter').value;
      const timeTo = document.getElementById('timeToFilter').value;

      if (dateFrom) params.append('date_from', dateFrom);
      if (dateTo) params.append('date_to', dateTo);
      if (timeFrom) params.append('time_from', timeFrom);
      if (timeTo) params.append('time_to', timeTo);

      const status = document.getElementById('statusFilter').value;
      if (status !== "") params.append('is_active', status);

      try {
        const res = await fetch('/api/points?' + params.toString());
        const data = await res.json();
        updateMap(data);
      } catch (err) {
        console.error(err);
      }
    }

  // ===================================================
  // === 6. –õ–ò–ù–ò–ò ================================
  // ===================================================
  const mergeBtn = document.getElementById('mergeLines');
  mergeBtn.addEventListener('click', () => {
    const userId = document.getElementById('lineUser').value;
    const dateFrom = document.getElementById('lineDateFrom').value;
    const dateTo = document.getElementById('lineDateTo').value;
    toggleLinesForUser(userId, dateFrom, dateTo);
  });

  async function toggleLinesForUser(userId, dateFrom, dateTo) {
    if (linesVisible) {
      linesLayer.clearLayers();
      popupGroup.forEach(p => map.removeLayer(p));
      popupGroup = [];
      linesVisible = false;
      mergeBtn.textContent = "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å";
      mergeBtn.style.backgroundColor = "";
      updateMap(allPoints);
      return;
    }
    if (!userId) return;

    const params = new URLSearchParams({ user_id: userId });
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);

    try {
      const res = await fetch('/api/points?' + params.toString());
      const data = await res.json();
      if (!data.length) return;

      updateMap(data);

      const pointsByDate = {};
      data.forEach(pt => (pointsByDate[pt.date] ||= []).push(pt));
      Object.keys(pointsByDate).forEach(date => {
        const dayPoints = pointsByDate[date].sort((a,b)=>a.time.localeCompare(b.time));
        const latlngs = dayPoints.map(p=>[p.lat,p.lon]);
        const line = L.polyline(latlngs,{color:'red',weight:4}).addTo(linesLayer);
        let dist=0; for(let i=1;i<latlngs.length;i++) dist+=map.distance(latlngs[i-1],latlngs[i]); dist/=1000;
        const popup = L.popup({closeButton:false,autoClose:false})
          .setLatLng(line.getBounds().getCenter())
          .setContent(`${userId} ‚Äî ${dayPoints.length} —Ç–æ—á–µ–∫, ${dist.toFixed(2)} –∫–º`)
          .openOn(map);
        popupGroup.push(popup);
      });

      mergeBtn.textContent="–û—Ç–º–µ–Ω–∏—Ç—å";
      mergeBtn.style.backgroundColor="blue";
      linesVisible=true;
    } catch(err){console.error(err);}
  }

  // ===================================================
  // === 7. –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================
  // ===================================================
  // === 7.1 Select All points ===
  // ===================================================
// === 7. –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================
// ===================================================

// === 7.1 –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–æ—á–µ–∫ ===
let allSelected = false;
const selectAllBtn = document.getElementById('select-all-btn');

selectAllBtn.addEventListener('click', () => {
  if (!allSelected) {
    // ‚úÖ –≤—ã–±—Ä–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏
    selectedPoints = [...allPoints];
    selectedPoints.forEach(pt => pt.marker?.setIcon(selectedIcon));
    selectAllBtn.style.backgroundColor = "green";
  } else {
    // üîÑ —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    selectedPoints.forEach(pt => pt.marker?.setIcon(pt.status === 1 ? activeIcon : passiveIcon));
    selectedPoints = [];
    selectAllBtn.style.backgroundColor = "";
  }
  allSelected = !allSelected;
});

// === 7.2 –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ ===
let toggleToPassive = true; // –ø–µ—Ä–≤–∞—è —Å–º–µ–Ω–∞ -> –¥–µ–ª–∞–µ–º –ø–∞—Å—Å–∏–≤–Ω—ã–º–∏
const changeStatusBtn = document.getElementById('change-status-btn');

changeStatusBtn.addEventListener('click', async () => {
  if (!selectedPoints.length) {
    alert("No points selected.");
    return;
  }

  // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ UI
  selectedPoints.forEach(pt => {
    pt.status = toggleToPassive ? 0 : 1;
    pt.marker?.setIcon(pt.status === 1 ? activeIcon : passiveIcon);
  });

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  try {
    const res = await fetch('/change_status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ids: selectedPoints.map(p => p.id),
        new_status: toggleToPassive ? 0 : 1
      })
    });
    const data = await res.json();
    if (!data.success) {
      alert("Error updating status.");
    }
  } catch {
    alert("Server error while changing status.");
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
  toggleToPassive = !toggleToPassive;

  // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–≤–µ—Ç –∫–Ω–æ–ø–æ–∫
  selectedPoints.forEach(pt => pt.marker?.setIcon(pt.status === 1 ? activeIcon : passiveIcon));
  selectedPoints = [];
  allSelected = false;
  selectAllBtn.style.backgroundColor = "";
});

// === 7.3 –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ ===
const deleteBtn = document.getElementById('delete-btn');

deleteBtn.addEventListener('click', async () => {
  if (!selectedPoints.length) {
    alert("No points selected.");
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–∞—Å—Å–∏–≤–Ω—ã–µ
  if (!selectedPoints.every(pt => pt.status === 0)) {
    alert("You can only delete points with PASSIVE status.");
    return;
  }

  if (!confirm("Are you sure you want to delete these points?")) return;

  try {
    const res = await fetch('/delete_points', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: selectedPoints.map(p => p.id) })
    });
    const data = await res.json();

    if (data.success) {
      // –£–¥–∞–ª—è–µ–º —Å –∫–∞—Ä—Ç—ã –∏ –∏–∑ –ø–∞–º—è—Ç–∏
      selectedPoints.forEach(pt => map.removeLayer(pt.marker));
      selectedPoints = [];
      allSelected = false;
      selectAllBtn.style.backgroundColor = "";
      alert("Points deleted successfully.");
    } else {
      alert("Error deleting points.");
    }
  } catch {
    alert("Server error while deleting points.");
  }
});



</script>


{% endblock %}

























